<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—çƒå¤šç¬¦è¨ˆåˆ†å°å¹«æ‰‹</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Google Material Symbols (ç”¨æ–¼å¾©åŸæŒ‰éˆ•) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=undo" />
    <style>
        /* ä½¿ç”¨ Inter å­—é«”ä»¥ç¢ºä¿è¦–è¦ºæ•ˆæœå’Œ Tailwind ä¿æŒä¸€è‡´ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f5f0; /* Soft, Snowy White Background */
        }
        /* å®šç¾©æ¯å­çš„åŸºæœ¬æ¨£å¼ */
        .cup {
            width: 70px;
            height: 70px;
            border-radius: 50%; /* æ‰å¹³åŒ–/ç°¡ç´„çš„åœ“è§’ */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 8px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* æ‰å¹³åŒ–å¾®å¼±é™°å½± */
            border: 3px solid transparent;
            font-size: 24px;
            font-weight: bold;
            background-color: white;
            color: #333;
        }
        .cup:active {
            transform: scale(0.98); /* ç¸®å°ç¨‹åº¦æ¸›å°‘ï¼Œæ›´æ‰å¹³åŒ– */
            box-shadow: none;
        }
        /* å‘½ä¸­è¨ˆæ•¸å™¨çš„æ¨£å¼ - è–èª•ç´…è‰² */
        .hit-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #a00000; /* Deep Christmas Red */
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px; /* æ‰å¹³åŒ–æ–¹å½¢åœ“è§’ */
            min-width: 24px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        /* é‚Šæ¡†é¡è‰² - é…åˆè–èª•é…è‰² */
        .cup[data-score="100"] { border-color: #ffd700; } /* Gold Accent */
        .cup[data-id="devil"] { border-color: #006400; } /* Dark Green for Devil */
        .cup[data-id="bomb"] { border-color: #a00000; } /* Deep Red for Bomb */
        .cup[data-score="50"] { border-color: #4CAF50; } /* Green */
        .cup[data-score="30"] { border-color: #ff9800; } /* Orange */
        .cup[data-score="20"] { border-color: #2196F3; } /* Blue */
        .cup[data-score="10"] { border-color: #9C27B0; } /* Purple */

        /* å°ˆé–€ç‚ºã€Œå¹ºç™½å¹ºã€èª¿æ•´å­—é«”ï¼Œé˜²æ­¢æ›è¡Œ */
        .cup-small-text {
            font-size: 18px; 
        }
        /* ç¢ºä¿ Material Symbols åœ¨æŒ‰éˆ•å…§å±…ä¸­ */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* èª¿æ•´å­—é«”å¤§å°ä»¥é©æ‡‰æ‰‹æ©Ÿè¢å¹• */
        @media (max-width: 600px) {
            .cup {
                width: 60px;
                height: 60px;
                margin: 6px;
                font-size: 20px;
            }
            .cup-small-text {
                 font-size: 15px; 
            }
            .score-title {
                font-size: 1.5rem;
            }
            .score-value {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center min-h-screen">

    <!-- èª¿æ•´é–“è·ï¼šmb-6 æ”¹ç‚º mb-10 -->
    <div class="text-center">
        <h1 class="text-3xl font-extrabold score-title mb-2" style="color: #a00000;">å­—çƒå¤šç¬¦</h1>
        <p class="text-gray-500 mb-6">è¨ˆåˆ†å°å¹«æ‰‹</p>
    </div>

    <!-- æ¯å­é™£åˆ— - æ‰å¹³åŒ–è¨­è¨ˆ -->
    <div id="cup-container" class="flex flex-col items-center p-4 bg-white shadow-lg rounded-2xl border border-gray-100">
        <!-- Cups will be rendered here by JavaScript -->
    </div>

    <!-- åˆ†æ•¸é¡¯ç¤ºå€ - ç°¡ç´„è¨­è¨ˆ -->
    <div class="mt-8 w-full max-w-xl bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
        <div class="flex items-center justify-between mb-4">
            <p class="text-2xl font-semibold text-gray-700 score-title">ç›®å‰å¾—åˆ†ï¼š</p>
            <!-- åˆ†æ•¸é¡è‰²ï¼šæ­£åˆ†ç¶ ï¼Œè² åˆ†ç´… -->
            <span id="total-score" class="text-6xl font-black score-value" style="color: #a00000;">0</span>
        </div>
        <div class="mb-4">
            <p class="text-sm font-medium text-gray-500 mb-1">è¨ˆåˆ†æ˜ç´°ï¼š</p>
            <p id="score-details" class="text-lg text-gray-800 font-mono min-h-6">0</p>
        </div>
        
        <!-- æ§åˆ¶æŒ‰éˆ• (æ¸…é™¤èˆ‡å¾©åŸ) - æ‰å¹³åŒ–æŒ‰éˆ• -->
        <div class="flex justify-end space-x-4 pt-4 border-t border-gray-100 mt-4">
            <!-- å¾©åŸæŒ‰éˆ• (Undo) - ç°¡ç´„ç°è‰² -->
            <button id="undo-button" disabled class="p-3 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" title="å¾©åŸä¸Šä¸€æ­¥">
                <span class="material-symbols-outlined">undo</span>
            </button>

            <!-- æ¸…é™¤æŒ‰éˆ• (Reset) - è–èª•ç´…è‰² -->
            <button id="clear-button" disabled class="p-3 text-white rounded-lg hover:bg-red-700 transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" style="background-color: #a00000;" title="æ¸…é™¤æ‰€æœ‰åˆ†æ•¸">
                <!-- Icon: Trash/Reset -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>
    </div>

    <!-- <div class="mt-8 text-center text-sm text-gray-400">
        <h3 class="font-semibold text-gray-600 mb-1">ç‰¹æ®Šè¦å‰‡ï¼šæƒ¡é­”èˆ‡ç‚¸å½ˆ (ğŸ˜ˆ/ğŸ’£)</h3>
        <ul class="list-disc list-inside space-y-1 mt-2 text-left inline-block">
            <li>**D=0**: ç‚¸å½ˆæ‰£é™¤ N å€‹æœ€é«˜åˆ†çš„æ¯å­åˆ†æ•¸ (N = B æ¬¡æ•¸)ã€‚</li>
            <li>**D>0**: æƒ¡é­”çµ„åˆçµ¦äºˆ +200 åˆ†/å°ã€‚è¶…é¡ç‚¸å½ˆæœƒå…ˆæ‰£é™¤çµ„åˆåˆ† 200ï¼Œä¹‹å¾Œçš„å†æ‰£é™¤æœ€é«˜åˆ†çš„æ¯å­åˆ†æ•¸ã€‚</li>
            <li>æ‰€æœ‰ç‚¸å½ˆæ‰£åˆ†ä¸æœƒä½¿**åˆ†æ•¸ä½æ–¼é›¶**ã€‚</li>
        </ul>
    </div> -->

    <script>
        // æ ¸å¿ƒæ•¸æ“šçµæ§‹èˆ‡ DOM å¼•ç”¨
        const initialCupData = [
            // Row 1 (+100)
            { id: 'star', content: 'â­', baseScore: 100, special: 'SCORABLE', row: 1 },
            // Row 2 (-30, Deduct Highest) - æƒ¡é­”å’Œç‚¸å½ˆBaseScoreéƒ½è¨­ç‚º0ï¼Œä»¥ä¾¿ç¨ç«‹è™•ç†å…¶è¤‡é›œè¦å‰‡
            { id: 'devil', content: 'ğŸ˜ˆ', baseScore: 0, special: 'DEVIL', row: 2 }, 
            { id: 'bomb', content: 'ğŸ’£', baseScore: 0, special: 'BOMB', row: 2 }, 
            // Row 3 (+50)
            { id: 'ji', content: 'å³', baseScore: 50, special: 'SCORABLE', row: 3 },
            { id: 'zhi', content: 'å¹ºç™½å¹º', baseScore: 50, special: 'SCORABLE', row: 3, classes: 'cup-small-text' }, 
            { id: 'feng', content: 'è±Š', baseScore: 50, special: 'SCORABLE', row: 3 },    
            // Row 4 (+30)
            { id: 'yang', content: 'å¤¬', baseScore: 30, special: 'SCORABLE', row: 4 },    
            { id: 'ren', content: 'å£¬', baseScore: 30, special: 'SCORABLE', row: 4 },
            { id: 'yan', content: 'å»¶', baseScore: 30, special: 'SCORABLE', row: 4 },
            { id: 'wu', content: 'å‹¿', baseScore: 30, special: 'SCORABLE', row: 4 },
            // Row 5 (+20)
            { id: 'niu', content: 'ç‰›', baseScore: 20, special: 'SCORABLE', row: 5 },
            { id: 'zhu', content: 'ç«¹', baseScore: 20, special: 'SCORABLE', row: 5 },
            { id: 'er', content: 'è€³', baseScore: 20, special: 'SCORABLE', row: 5 },
            // Row 6 (+10)
            { id: 'mu', content: 'æœ¨', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'kou', content: 'å£', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'xin', content: 'å¿ƒ', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'yan2', content: 'è¨€', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'shi', content: 'ç¤º', baseScore: 10, special: 'SCORABLE', row: 6 },
        ];

        let cupsState = [];
        let history = []; 
        const cupLayoutByRow = {};
        
        const cupContainer = document.getElementById('cup-container');
        const totalScoreEl = document.getElementById('total-score');
        const scoreDetailsEl = document.getElementById('score-details');


        // --- è¼”åŠ©å‡½æ•¸ç¾¤ (ç½®é ‚ä»¥ç¢ºä¿ä½œç”¨åŸŸæ­£ç¢º) ---

        // ç¢ºä¿åˆ†æ•¸ä¸ä½æ–¼é›¶
        function safeDeduct(currentScore, deductionAmount) {
            const finalScore = currentScore - deductionAmount;
            return Math.max(0, finalScore);
        }

        // éœæ…‹ä½ˆå±€è¨­ç½®
        function setupInitialLayout() {
            initialCupData.forEach(cup => {
                if (!cupLayoutByRow[cup.row]) { cupLayoutByRow[cup.row] = []; }
                cupLayoutByRow[cup.row].push(cup);
            });
        }

        // å„²å­˜æ­·å²ç‹€æ…‹
        function saveHistory() {
            const currentStateClone = cupsState.map(cup => ({ ...cup }));
            history.push(currentStateClone);
            if (history.length > 15) { history.shift(); }
        }
        
        // å¾©åŸä¸Šä¸€æ­¥
        function undoLastAction() {
            if (history.length > 0) {
                const previousState = history.pop();
                cupsState = previousState;
                
                renderCups();
                updateDisplay();
                updateControlButtons(); 
            }
        }

        // æ›´æ–°æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
        function updateControlButtons() {
            const undoButton = document.getElementById('undo-button');
            const clearButton = document.getElementById('clear-button');
            const canUndo = history.length > 0;
            if (undoButton) {
                undoButton.disabled = !canUndo;
                undoButton.classList.toggle('opacity-50', !canUndo);
                undoButton.classList.toggle('cursor-not-allowed', !canUndo);
            }
            const hasHits = cupsState.some(cup => cup.hits > 0);
            if (clearButton) {
                clearButton.disabled = !hasHits;
                clearButton.classList.toggle('opacity-50', !hasHits);
                clearButton.classList.toggle('cursor-not-allowed', !hasHits);
            }
        }
        
        // åˆå§‹åŒ–èˆ‡é‡ç½®ç‹€æ…‹
        function initializeState() {
            cupsState = initialCupData.map(cup => ({ ...cup, hits: 0 }));
            history = []; 
            renderCups();
            updateDisplay();
            updateControlButtons(); 
        }

        // æ¸²æŸ“æ¯å­
        function renderCups() {
            cupContainer.innerHTML = ''; 
            Object.keys(cupLayoutByRow).sort((a, b) => parseInt(a) - parseInt(b)).forEach(rowKey => {
                const row = cupLayoutByRow[rowKey];
                const rowDiv = document.createElement('div');
                rowDiv.className = 'flex justify-center'; 
                row.forEach(cupDefinition => {
                    const currentState = cupsState.find(c => c.id === cupDefinition.id);
                    const hits = currentState ? currentState.hits : 0;
                    const cupDiv = document.createElement('div');
                    cupDiv.className = 'cup';
                    cupDiv.dataset.id = cupDefinition.id;
                    cupDiv.dataset.score = cupDefinition.baseScore;
                    cupDiv.dataset.special = cupDefinition.special;
                    if (cupDefinition.classes) { cupDiv.classList.add(cupDefinition.classes); }
                    cupDiv.onclick = () => handleClick(cupDefinition.id);
                    cupDiv.innerHTML = `
                        <span>${cupDefinition.content}</span>
                        ${hits > 0 ? `<span class="hit-count">Ã—${hits}</span>` : ''}
                    `;
                    rowDiv.appendChild(cupDiv);
                });
                cupContainer.appendChild(rowDiv);
            });
        }
        
        // --- é»æ“Šäº‹ä»¶è™•ç† ---
        function handleClick(cupId) {
            saveHistory();

            const cup = cupsState.find(c => c.id === cupId);
            if (cup) {
                cup.hits += 1;
                renderCups(); 
                updateDisplay(); 
                updateControlButtons(); 
            }
        }


        /**
         * æ ¸å¿ƒåˆ†æ•¸è¨ˆç®—é‚è¼¯ - å¯¦ç¾å…©ç¨®ç¨ç«‹çš„ç‚¸å½ˆæ‡²ç½°æ¨¡å¼
         */
        function calculateScore() {
            let baseScoreTotal = 0; // SCORABLE æ¯å­çš„åˆ†æ•¸ç¸½å’Œ
            let breakdownParts = [];
            
            // 1. å–å¾— D/B æ¬¡æ•¸
            const devilCup = cupsState.find(c => c.id === 'devil');
            const bombCup = cupsState.find(c => c.id === 'bomb');
            const D = devilCup ? devilCup.hits : 0;
            const B = bombCup ? bombCup.hits : 0;
            
            let comboScore = 0;
            let excessDemonPenalty = 0;
            
            // æ”¶é›†æ‰€æœ‰ SCORABLE æ­£åˆ†é …ç›®çš„å–®ç¨åˆ†æ•¸ (ç”¨æ–¼æ‰£é™¤)
            let deductibleScores = []; 

            // 2. è¨ˆç®—æ‰€æœ‰ã€SCORABLEã€‘æ¯å­çš„åŸºæœ¬åˆ†æ•¸ï¼Œä¸¦æ”¶é›†å¯æ‰£é™¤é …ç›® (æ­£åˆ†)
            cupsState.forEach(cup => {
                if (cup.special === 'SCORABLE' && cup.hits > 0) {
                    const score = cup.baseScore * cup.hits;
                    baseScoreTotal += score;
                    
                    const sign = cup.baseScore >= 0 ? '+' : '';
                    breakdownParts.push(`${sign}${cup.baseScore}Ã—${cup.hits}`);

                    if (cup.baseScore > 0) {
                        for (let i = 0; i < cup.hits; i++) {
                            deductibleScores.push(cup.baseScore);
                        }
                    }
                }
            });
            
            // 3. è™•ç† D/B ç‹€æ…‹
            let totalScore = baseScoreTotal; // é è¨­åˆ†æ•¸ç‚º SCORABLE ç¸½å’Œ

            if (B > 0) {
                breakdownParts.push(`ğŸ’£Ã—${B}`);
            }
            
            if (D === 0 && B > 0) {
                // --- æ¨¡å¼ A: æƒ¡é­”ä¸åœ¨å ´ (D=0, B>0) - æ‰£é™¤æœ€é«˜åˆ†æ‡²ç½° ---
                
                if (deductibleScores.length > 0) {
                    deductibleScores.sort((a, b) => b - a);
                    
                    let deductionAmount = 0;
                    const timesToDeduct = Math.min(B, deductibleScores.length);
                    
                    for (let i = 0; i < timesToDeduct; i++) {
                        deductionAmount += deductibleScores[i];
                    }
                    
                    // å¾ç¸½åˆ†ä¸­å®‰å…¨æ‰£é™¤ï¼Œç¢ºä¿ >= 0
                    totalScore = safeDeduct(totalScore, deductionAmount);
                    
                    if (deductionAmount > 0) {
                        // ç°¡åŒ–æ˜ç´°å‘ˆç¾
                        breakdownParts.length = 0; 
                        breakdownParts.push(`SCORABLE ç¸½åˆ†: ${baseScoreTotal}`);
                        breakdownParts.push(`(-${deductionAmount}) [ğŸ’£${B} æ‰£é™¤å‰ ${timesToDeduct} é«˜åˆ†]`);
                    }
                }

            } else if (D > 0) {
                // --- æ¨¡å¼ B: æƒ¡é­”åœ¨å ´ (D>0) - çµ„åˆçå‹µèˆ‡çµ„åˆæ‡²ç½° ---

                const comboCount = Math.min(D, B); 
                const excessBombCount = B - D;
                const excessDemonCount = D - B;
                let deductionSummary = [];

                // 1. çµ„åˆçå‹µ
                if (comboCount > 0) {
                    comboScore = comboCount * 200;
                    totalScore += comboScore;
                    breakdownParts.push(`(+${comboScore}) [ğŸ˜ˆ${comboCount}+ğŸ’£${comboCount} çµ„åˆçå‹µ]`);
                }

                // 2. è¶…é¡æƒ¡é­”æ‡²ç½° (D > B)
                if (excessDemonCount > 0) {
                    excessDemonPenalty = excessDemonCount * (-30); 
                    totalScore += excessDemonPenalty;
                    breakdownParts.push(`(${excessDemonPenalty}) [ğŸ˜ˆ${excessDemonCount} è¶…é¡æ‡²ç½°]`);
                }

                // 3. è¶…é¡ç‚¸å½ˆæ‡²ç½° (B > D) - å…©éšæ®µæ‰£é™¤
                let bombsRemainingToDeduct = excessBombCount;
                
                if (bombsRemainingToDeduct >= 1) {
                    // éšæ®µ 1: ç¬¬ä¸€é¡†è¶…é¡ç‚¸å½ˆæ‰£é™¤ 200 åˆ† (çµ„åˆåˆ†)
                    const deduction1 = 200; 
                    const actualDeduction1 = Math.min(deduction1, totalScore);
                    totalScore = safeDeduct(totalScore, deduction1);
                    bombsRemainingToDeduct--;
                    deductionSummary.push(`(-${actualDeduction1}) [ğŸ’£1 æŠµéŠ·çµ„åˆåˆ†]`);
                }

                if (bombsRemainingToDeduct >= 1 && deductibleScores.length > 0) {
                    // éšæ®µ 2: å‰©é¤˜çš„è¶…é¡ç‚¸å½ˆæ‰£é™¤æœ€é«˜åˆ†çš„æ¯å­åˆ†æ•¸
                    deductibleScores.sort((a, b) => b - a);
                    
                    for (let i = 0; i < bombsRemainingToDeduct && i < deductibleScores.length; i++) {
                        const deduction2 = deductibleScores[i];
                        const actualDeduction2 = Math.min(deduction2, totalScore);
                        totalScore = safeDeduct(totalScore, deduction2);
                        bombsRemainingToDeduct--;
                        deductionSummary.push(`(-${actualDeduction2}) [ğŸ’£ é¡å¤–æ‰£é™¤æœ€é«˜åˆ†]`);
                    }
                }
                
                // å°‡ç‚¸å½ˆæ‡²ç½°æ˜ç´°åŠ å…¥ç¸½æ˜ç´°ä¸­
                breakdownParts.push(...deductionSummary);

            } else if (D > 0 && B === 0) {
                 // åªæœ‰æƒ¡é­”ï¼Œæ²’æœ‰ç‚¸å½ˆ
                 excessDemonPenalty = D * (-30);
                 totalScore = safeDeduct(totalScore, excessDemonPenalty * -1); // æ‰£é™¤è² åˆ†
                 breakdownParts.push(`(${excessDemonPenalty}) [ğŸ˜ˆ${D} å–®ç¨æ‡²ç½°]`);
            }
            
            // 4. æ ¼å¼åŒ–åˆ†æ•¸æ˜ç´°
            if (breakdownParts.length === 0) {
                breakdownParts.push('0');
            }
            const detailsText = breakdownParts.join(' + ');

            return { totalScore, detailsText };
        }

        // --- UI æ¸²æŸ“èˆ‡æ§åˆ¶å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        function updateDisplay() {
            const { totalScore, detailsText } = calculateScore();
            totalScoreEl.textContent = totalScore.toLocaleString();
            scoreDetailsEl.textContent = detailsText;
            
            // è–èª•é…è‰²ï¼šæ­£åˆ†ç¶ ï¼Œè² åˆ†ç´…
            if (totalScore > 0) {
                totalScoreEl.style.color = '#006400'; /* Forest Green */
                totalScoreEl.classList.remove('text-gray-500');
            } else if (totalScore < 0) {
                totalScoreEl.style.color = '#a00000'; /* Deep Red */
                totalScoreEl.classList.remove('text-gray-500');
            } else {
                totalScoreEl.style.color = '#a00000'; /* 0 åˆ†ä½¿ç”¨ç´…è‰² */
            }
        }

        // --- ä¸»ç¨‹å¼é€²å…¥é» ---
        window.onload = () => {
            setupInitialLayout();
            initializeState();
            
            const clearButton = document.getElementById('clear-button');
            const undoButton = document.getElementById('undo-button');
            
            clearButton.addEventListener('click', () => {
                if (cupsState.some(cup => cup.hits > 0)) { saveHistory(); }
                initializeState();
            });

            undoButton.addEventListener('click', undoLastAction);
        };
    </script>
</body>
</html>
