<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—çƒå¤šç¬¦è¨ˆåˆ†å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f5f0; 
            overflow-x: hidden;
            padding-bottom: 220px;
        }
        
        /* æ¯å­æ¨£å¼ */
        .cup {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: all 0.1s ease-in-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); 
            border: 3px solid transparent;
            font-size: 24px;
            font-weight: bold;
            background-color: white;
            color: #333;
            z-index: 10;
        }
        .cup:active { transform: scale(0.92); box-shadow: none; }
        
        .hit-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #a00000; 
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px; 
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid white;
        }

        .cup[data-score="100"] { border-color: #ffd700; }
        .cup[data-id="devil"] { border-color: #006400; }
        .cup[data-id="bomb"] { border-color: #a00000; }
        .cup[data-score="50"] { border-color: #4CAF50; }
        .cup[data-score="30"] { border-color: #ff9800; }
        .cup[data-score="20"] { border-color: #2196F3; }
        .cup[data-score="10"] { border-color: #9C27B0; }
        .cup-small-text { font-size: 18px; }

        /* ç›´å¼ç®—å¼å€å¡Š */
        #calculation-log {
            position: fixed;
            top: 80px;
            right: 10px;
            width: 280px;
            max-height: calc(100vh - 320px);
            overflow-y: auto;
            pointer-events: none;
            scrollbar-width: none; 
            z-index: 5;
            padding-right: 5px;
        }
        #calculation-log::-webkit-scrollbar { display: none; }

        .log-entry {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 6px;
            padding: 6px 10px;
            border-radius: 6px;
            background-color: rgba(255,255,255,0.7);
            backdrop-filter: blur(2px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .log-desc {
            color: #666;
            font-size: 15px;
            margin-right: 12px;
            text-align: right;
            flex-grow: 1;
            line-height: 1.2;
        }
        
        .log-value {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #333;
            width: 60px;
            text-align: right;
        }

        .strike-through .log-desc {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .strike-through .log-value {
            text-decoration: line-through;
            color: #9ca3af !important;
            opacity: 0.6;
        }

        .text-combo { color: #006400 !important; font-weight: 600; } 
        .text-bomb { color: #e11d48 !important; font-weight: 600; }
        .text-bonus { color: #3f5a52 !important; font-weight: 600; }

        /* ä½ˆå±€ */
        #cup-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .cup-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            margin-bottom: 8px;
        }

        .row-label {
            position: absolute;
            left: 10px;
            width: 100px;
            text-align: left;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        /* åº•éƒ¨å·¥å…·åˆ— */
        #bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            padding: 12px;
            z-index: 50;
            border-top: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tool-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bonus-btn {
            background-color: #e5ebe9;
            color: #3f5a52;
            border: 1px solid #c8d3cf;
            padding: 8px 14px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap;
        }
        .bonus-btn:hover { background-color: #d1dbd8; transform: translateY(-1px); }
        .bonus-btn:active { transform: translateY(0); }

        .control-btn {
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: 500;
        }

        @media (max-width: 600px) {
            .cup { width: 50px; height: 50px; font-size: 20px; margin: 3px; }
            .row-label { font-size: 12px; width: 60px; left: 5px; }
            #calculation-log { 
                top: 70px; width: 100%; right: 0; padding: 10px; 
                max-height: 180px; background: none; 
                pointer-events: none;
            }
            .log-entry { background-color: rgba(255,255,255,0.9); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            #bottom-toolbar { padding: 10px; padding-bottom: 20px; }
            .bonus-btn { padding: 6px 10px; font-size: 12px; }
        }

        #rule-pin-button { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .modal { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="p-4">

    <!-- è¦å‰‡æŒ‰éˆ• -->
    <button id="rule-pin-button" class="p-3 bg-white text-gray-700 rounded-full hover:bg-gray-100 transition shadow-lg border border-gray-100">
        <span class="material-symbols-outlined" style="color: #a00000;">attach_file</span>
    </button>
    
    <!-- è¦å‰‡ Modal -->
    <div id="rule-modal" class="modal fixed inset-0 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 border-t-4 border-[#a00000] m-auto relative">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-[#006400]">éŠæˆ²è¦å‰‡</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="rule-content" class="text-gray-700 space-y-3 max-h-96 overflow-y-auto text-sm">
                
                    <h3>ä½ æ˜¯ä¸€ä½<strong>ç…‰å­—è¡“å¸«</strong>ï¼Œé™¤äº†è¦ç²¾æº–çš„åœ¨Xçƒå…§ç›¡å¯èƒ½æŠ•é€²æ„ˆå¤šéƒ¨ä»¶ã€åˆ©ç”¨éƒ¨ä»¶çµ„å­—ï¼Œé‚„å¿…é ˆæ»¿è¶³å®¢æˆ¶çš„éœ€æ±‚â‹¯â‹¯</h3>
                    <h3>è«‹å„ä½<strong>å­—çƒå¤šç¬¦ï¼</strong></h3>
                <p class="font-semibold text-[#a00000]">éŠæˆ²æµç¨‹</p>
                            
                <ul class="list-disc pl-2 space-y-1">
                <h3>1. é–‹å§‹æŠ•çƒ<br>2. æŠ•å®Œä¸€åŠçƒæ•¸å¾Œï¼ŒæŠ½å–ä¸€å¼µå®¢æˆ¶æ„è¦‹å¡<br>3. ä¾ç…§å®¢æˆ¶æ„è¦‹ï¼ŒæŠ•å®Œå‰©ä¸‹çš„çƒ<br>4. åˆ©ç”¨æŠ•é€²çš„éƒ¨ä»¶ï¼Œåœ¨å°ç™½æ¿ä¸Šçµ„æˆå­—<br>5. çµç®—åˆ†æ•¸</h3></ul>
                <p class="font-semibold text-[#a00000]">è¨ˆåˆ†è¦å‰‡</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>æ¯æ’åˆ†æ•¸å¦‚å·¦å´æ¨™ç¤ºã€‚</li>
                    <li>ğŸ˜ˆ <strong>æƒ¡é­”</strong>
                        <ul class="pl-4 mt-1 border-l-2 border-red-100">
                                <li>åˆ†æ•¸ -30</li>
                                <li>èˆ‡ç‚¸å½ˆçµ„åˆæˆ +200ï¼Œç§»é™¤æ‡²ç½°æ•ˆæœ</li>
                            </ul>
                    <li>ğŸ’£ <strong>ç‚¸å½ˆ</strong>
                        <ul class="pl-4 mt-1 border-l-2 border-red-100">
                            <li>å°‡æœ€é«˜åˆ†æ‰£é™¤</li>
                            <li>èˆ‡æƒ¡é­”çµ„åˆæˆ +200ï¼Œç§»é™¤æ‡²ç½°æ•ˆæœ</li>
                        
                        </ul>
                    </li>
                    <li>ğŸ”  <strong>çµ„å­—</strong>
                        <ul class="pl-4 mt-1 border-l-2 border-red-100">
                            <li>ç”¨åˆ° 2 éƒ¨ä»¶ +100</li>
                            <li>ç”¨åˆ° 3 éƒ¨ä»¶ +150</li>
                            <li>ç”¨åˆ° 4 éƒ¨ä»¶ä»¥ä¸Š +200</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- æ¨™é¡Œ -->
    <div class="text-center mb-6 mt-2">
        <h1 class="text-4xl font-extrabold tracking-tight text-[#a00000]mb-4">å­—çƒå¤šç¬¦</h1>
        <p class="text-gray-500 font-medium">è¨ˆåˆ†å°å¹«æ‰‹</p>
    </div>

    <!-- ç›´å¼ç®—å¼ -->
    <div id="calculation-log"></div>

    <!-- æ¯å­å€åŸŸ -->
    <div id="cup-container"></div>

    <!-- åº•éƒ¨å·¥å…·åˆ— -->
    <div id="bottom-toolbar">
        <div class="flex justify-between items-center px-4 w-full max-w-2xl mx-auto border-b border-gray-100 pb-2 mb-1">
            <span class="text-gray-500 font-semibold">ç›®å‰åˆ†æ•¸</span>
            <span id="total-score-display" class="text-4xl font-black text-[#a00000]">0</span>
        </div>

        <div class="tool-row">
            <button class="bonus-btn" onclick="addBonus(100, '2éƒ¨ä»¶')">çµ„å­—(2éƒ¨ä»¶)+100</button>
            <button class="bonus-btn" onclick="addBonus(150, '3éƒ¨ä»¶')">çµ„å­—(3éƒ¨ä»¶)+150 </button>
            <button class="bonus-btn" onclick="addBonus(200, '4+éƒ¨ä»¶')">çµ„å­—(4+éƒ¨ä»¶)+200</button>
        </div>

        <div class="tool-row mt-1">
            <button id="undo-button" disabled class="control-btn bg-gray-100 text-gray-600 hover:bg-gray-200 disabled:opacity-50">
                <span class="material-symbols-outlined mr-1">undo</span> å¾©åŸ
            </button>
            <button id="clear-button" disabled class="control-btn bg-[#a00000] text-white hover:bg-[#800000] disabled:opacity-50">
                <span class="material-symbols-outlined mr-1">delete</span> é‡ç½®
            </button>
        </div>
    </div>

    <script>
        const initialCupData = [
            { id: 'star', content: 'â­', baseScore: 100, special: 'SCORABLE', row: 1 },
            { id: 'devil', content: 'ğŸ˜ˆ', baseScore: -30, special: 'DEVIL', row: 2 }, 
            { id: 'bomb', content: 'ğŸ’£', baseScore: 0, special: 'BOMB', row: 2 }, 
            { id: 'ji', content: 'å³', baseScore: 50, special: 'SCORABLE', row: 3 },
            { id: 'zhi', content: 'å¹ºç™½å¹º', baseScore: 50, special: 'SCORABLE', row: 3, classes: 'cup-small-text' }, 
            { id: 'feng', content: 'è±Š', baseScore: 50, special: 'SCORABLE', row: 3 },    
            { id: 'yang', content: 'å¤¬', baseScore: 30, special: 'SCORABLE', row: 4 },    
            { id: 'ren', content: 'å£¬', baseScore: 30, special: 'SCORABLE', row: 4 },
            { id: 'yan', content: 'å»¶', baseScore: 30, special: 'SCORABLE', row: 4 },
            { id: 'wu', content: 'å‹¿', baseScore: 30, special: 'SCORABLE', row: 4 },
            { id: 'niu', content: 'ç‰›', baseScore: 20, special: 'SCORABLE', row: 5 },
            { id: 'zhu', content: 'ç«¹', baseScore: 20, special: 'SCORABLE', row: 5 },
            { id: 'er', content: 'è€³', baseScore: 20, special: 'SCORABLE', row: 5 },
            { id: 'mu', content: 'æœ¨', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'kou', content: 'å£', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'xin', content: 'å¿ƒ', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'yan2', content: 'è¨€', baseScore: 10, special: 'SCORABLE', row: 6 },
            { id: 'shi', content: 'ç¤º', baseScore: 10, special: 'SCORABLE', row: 6 },
        ];

        const rowLabels = {
            1: '100',
            2: '-30 / æ‰£æœ€é«˜', 
            3: '50',
            4: '30',
            5: '20',
            6: '10'
        };

        let history = []; 
        let actionLog = []; 
        const cupContainer = document.getElementById('cup-container');
        const calcLogEl = document.getElementById('calculation-log');
        const totalScoreDisplay = document.getElementById('total-score-display');

        // --- ç‹€æ…‹ç®¡ç† ---
        function saveHistory() {
            const logClone = JSON.parse(JSON.stringify(actionLog));
            history.push(logClone);
            if (history.length > 20) { history.shift(); }
            updateControlButtons();
        }
        
        function undoLastAction() {
            if (history.length > 0) {
                actionLog = history.pop();
                render();
            }
            updateControlButtons();
        }

        function updateControlButtons() {
            document.getElementById('undo-button').disabled = history.length === 0;
            document.getElementById('clear-button').disabled = actionLog.length === 0;
        }

        function initializeState() {
            history = []; 
            actionLog = []; 
            render();
        }

        function handleCupClick(cupId) {
            saveHistory();
            actionLog.push({ type: 'cup', id: cupId });
            render();
        }

        window.addBonus = function(points, label) {
            saveHistory();
            actionLog.push({ type: 'bonus', value: points, label: label });
            render();
        }

        function render() {
            renderCups();
            calculateAndRenderLog();
            updateControlButtons();
        }

        function renderCups() {
            cupContainer.innerHTML = '';
            const hitCounts = {};
            actionLog.forEach(action => {
                if(action.type === 'cup') hitCounts[action.id] = (hitCounts[action.id] || 0) + 1;
            });

            const cupsByRow = {};
            initialCupData.forEach(c => {
                if(!cupsByRow[c.row]) cupsByRow[c.row] = [];
                cupsByRow[c.row].push(c);
            });

            Object.keys(cupsByRow).sort((a,b) => a-b).forEach(rowKey => {
                const rowEl = document.createElement('div');
                rowEl.className = 'cup-row';
                
                const labelEl = document.createElement('div');
                labelEl.className = 'row-label';
                labelEl.textContent = rowLabels[rowKey] || '';
                rowEl.appendChild(labelEl);

                const wrapper = document.createElement('div');
                wrapper.className = 'flex justify-center items-center gap-1';
                
                cupsByRow[rowKey].forEach(cupDef => {
                    const hits = hitCounts[cupDef.id] || 0;
                    const cupEl = document.createElement('div');
                    cupEl.className = 'cup';
                    cupEl.dataset.id = cupDef.id;
                    cupEl.dataset.score = cupDef.baseScore;
                    if(cupDef.classes) cupEl.classList.add(cupDef.classes);
                    
                    cupEl.innerHTML = `
                        ${cupDef.content}
                        ${hits > 0 ? `<span class="hit-count">${hits}</span>` : ''}
                    `;
                    cupEl.onclick = () => handleCupClick(cupDef.id);
                    wrapper.appendChild(cupEl);
                });
                rowEl.appendChild(wrapper);
                cupContainer.appendChild(rowEl);
            });
        }

        // --- æ ¸å¿ƒé‹ç®—ï¼šå…¨åŸŸç‹€æ…‹é‹ç®—é‚è¼¯ ---
        function calculateAndRenderLog() {
            let displayItems = []; 
            
            let devilIndices = [];
            let bombIndices = [];
            
            actionLog.forEach((action, idx) => {
                let item = {
                    logIdx: idx,
                    type: action.type,
                    desc: '',
                    value: 0,
                    isCancelled: false, 
                    isCombo: false, 
                    isBombDeduction: false
                };

                if (action.type === 'cup') {
                    const cup = initialCupData.find(c => c.id === action.id);
                    if (cup.id === 'devil') {
                        item.desc = `ğŸ˜ˆ (-30)`;
                        item.value = -30;
                        devilIndices.push(idx);
                    } else if (cup.id === 'bomb') {
                        item.desc = `ğŸ’£ å¾…å®š`; 
                        item.value = 0;
                        bombIndices.push(idx);
                    } else {
                        item.desc = `${cup.content} (${cup.baseScore})`;
                        item.value = cup.baseScore;
                    }
                } else if (action.type === 'bonus') {
                    item.desc = `ğŸ”  ${action.label} (${action.value})`;
                    item.value = action.value;
                }
                displayItems.push(item);
            });

            // 2. è™•ç†çµ„åˆ (ä¸è«–é †åº)
            const comboCount = Math.min(devilIndices.length, bombIndices.length);
            for (let i = 0; i < comboCount; i++) {
                const dIdx = devilIndices[i];
                const bIdx = bombIndices[i];
                displayItems[dIdx].isCancelled = true;
                displayItems[bIdx].value = 200;
                displayItems[bIdx].desc = `ğŸ˜ˆ+ğŸ’£ çµ„åˆ`;
                displayItems[bIdx].isCombo = true;
            }

            // 3. è™•ç†å‰©é¤˜ç‚¸å½ˆçš„æ‰£åˆ†é‚è¼¯
            const excessBombCount = bombIndices.length - comboCount;
            const excessBombIndices = bombIndices.slice(comboCount);

            excessBombIndices.forEach(bLogIdx => {
                // æ‰¾å‡ºå€™é¸äººï¼šæœªè¢«åŠƒæ‰ã€åˆ†æ•¸å¤§æ–¼0ã€ä¸”ä¸æ˜¯åŠ åˆ†æŒ‰éˆ•
                let candidates = displayItems.filter(item => 
                    !item.isCancelled && 
                    item.value > 0 && 
                    item.type !== 'bonus' // ä¿®æ­£ï¼šçµ„å­—åˆ†æ•¸ä¸å—ç‚¸å½ˆå½±éŸ¿
                );
                
                if (candidates.length > 0) {
                    candidates.sort((a, b) => b.value - a.value);
                    const target = candidates[0];
                    target.isCancelled = true;
                    
                    let targetName = target.desc.split(' ')[0]; 
                    if (target.isCombo) targetName = "çµ„åˆåˆ†";
                    
                    displayItems[bLogIdx].desc = `ğŸ’£ æŠµéŠ· ${targetName}`;
                    displayItems[bLogIdx].isBombDeduction = true;
                } else {
                    displayItems[bLogIdx].desc = `ğŸ’£ (ç„¡åˆ†å¯æ‰£)`;
                }
            });

            // 4. è¨ˆç®—ç¸½åˆ† & æ¸²æŸ“
            let total = 0;
            displayItems.forEach(item => {
                if (!item.isCancelled) total += item.value;
            });
            // ä¿®æ­£ï¼šç§»é™¤äº† Math.max(0, total)ï¼Œå…è¨±è² åˆ†é¡¯ç¤º

            // æ¸²æŸ“
            calcLogEl.innerHTML = '';
            const renderList = [...displayItems].reverse();

            if (renderList.length === 0) {
                calcLogEl.innerHTML = '<div class="text-center text-gray-400 mt-10">å°šç„¡ç´€éŒ„</div>';
            } else {
                renderList.forEach(item => {
                    const row = document.createElement('div');
                    let classes = 'log-entry';
                    if (item.isCancelled) classes += ' strike-through';
                    
                    let descHtml = item.desc;
                    if (item.isCombo && !item.isCancelled) descHtml = `<span class="text-combo">${item.desc}</span>`;
                    if (item.isBombDeduction) descHtml = `<span class="text-bomb">${item.desc}</span>`;
                    if (item.type === 'bonus') descHtml = `<span class="text-bonus">${item.desc}</span>`;

                    let valHtml = '';
                    if (item.value !== 0 && !item.isBombDeduction) {
                        valHtml = item.value;
                    }

                    row.className = classes;
                    row.innerHTML = `
                        <span class="log-desc">${descHtml}</span>
                        <span class="log-value">${valHtml}</span>
                    `;
                    calcLogEl.appendChild(row);
                });
            }

            // æ›´æ–°ç¸½åˆ†
            totalScoreDisplay.textContent = total;
            if(total > 0) totalScoreDisplay.style.color = '#006400';
            else totalScoreDisplay.style.color = '#a00000';
        }

        window.onload = () => {
            initializeState();
            
            const modal = document.getElementById('rule-modal');
            document.getElementById('rule-pin-button').onclick = () => {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            };
            document.getElementById('close-modal').onclick = () => {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            };
            modal.onclick = (e) => { 
                if(e.target === modal) {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            };

            document.getElementById('clear-button').onclick = () => {
                if(actionLog.length > 0) {
                    saveHistory(); 
                    actionLog = [];
                    render();
                }
            };
            document.getElementById('undo-button').onclick = undoLastAction;
        };
    </script>
</body>
</html>
