<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­—çƒå¤šç¬¦è¨ˆåˆ†å°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #044200; 
            overflow-x: hidden;
            padding-bottom: 260px; 
        }
        
        /* æ¯å­æ¨£å¼ */
        .cup {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: all 0.1s ease-in-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); 
            border: 3px solid transparent;
            font-size: 24px;
            font-weight: bold;
            background-color: white;
            color: #333;
            z-index: 10;
        }
        .cup:active { transform: scale(0.92); box-shadow: none; }
        
        /* é€šç”¨è¨ˆæ•¸å°ç´…é»æ¨£å¼ */
        .hit-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: #a00000; 
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px; 
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 2px solid white;
            z-index: 20;
        }

        /* ç‰¹å®šæ¯å­æ¨£å¼ */
        .cup[data-score="10"] { border-color: #ffd700; }
        .cup[data-id="devil"] { border-color: #006400; }
        .cup[data-id="bomb"] { border-color: #a00000; }
        .cup[data-score="5"] { border-color: #4CAF50; }
        .cup[data-score="3"] { border-color: #ff9800; }
        .cup[data-score="2"] { border-color: #2196F3; }
        .cup[data-score="1"] { border-color: #9C27B0; }
        .cup-small-text { font-size: 18px; }

        /* ç›´å¼ç®—å¼å€å¡Š */
        #calculation-log {
            position: fixed;
            top: 160px;
            right: 10px;
            width: 180px; /* ä¿®æ”¹ï¼šç¸®çŸ­å¯¬åº¦ (åŸæœ¬260px) */
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            pointer-events: none;
            scrollbar-width: none; 
            z-index: 5;
            padding-right: 5px;
            /* è®“å…§å®¹å¾åº•éƒ¨é–‹å§‹å †ç–Šçš„è¦–è¦ºæ•ˆæœ */
            display: flex;
            flex-direction: column;
        }
        #calculation-log::-webkit-scrollbar { display: none; }

        .log-entry {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 6px;
            padding: 6px 10px;
            border-radius: 8px; /* ç¨å¾®åœ“ä¸€é» */
            /* ä¿®æ”¹ï¼šèƒŒæ™¯æ›´é€æ˜ */
            background-color: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: auto; /* è¼”åŠ©åº•éƒ¨å°é½Š */
        }
        
        .log-desc {
            color: #e5e7eb; /* ä¿®æ”¹ï¼šå› ç‚ºèƒŒæ™¯è®Šé€æ˜æ·±è‰²ï¼Œæ–‡å­—æ”¹æ·ºè‰²ä¸€é»æ¯”è¼ƒæ¸…æ¥šï¼Œæˆ–è€…ä¿æŒæ·±è‰²çœ‹å°æ¯” */
            color: #0f390f; /* ä¿æŒæ·±ç¶ è‰²ç³»æ–‡å­—ï¼Œä½†åœ¨æ·ºç™½èƒŒæ™¯ä¸Š */
            font-size: 15px;
            margin-right: 8px;
            text-align: right;
            flex-grow: 1;
            line-height: 1.2;
            font-weight: 700;
        }
        
        .log-value {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 800;
            color: #000;
            width: 40px;
            text-align: right;
        }

        .strike-through .log-desc {
            text-decoration: line-through;
            color: #4b5563; /* æ·±ç° */
            opacity: 0.7;
        }
        .strike-through .log-value {
            text-decoration: line-through;
            color: #4b5563 !important;
            opacity: 0.6;
        }

        .text-combo { color: #006400 !important; font-weight: 800; text-shadow: 0 0 2px rgba(255,255,255,0.5); } 
        .text-bomb { color: #991b1b !important; font-weight: 800; }
        .text-bonus { color: #5c3a21 !important; font-weight: 800; }

        /* ä½ˆå±€ */
        #cup-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 10px;
        }

        .cup-row {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            margin-bottom: 10px;
        }

        .row-label {
            position: absolute;
            left: 10px;
            width: 110px;
            text-align: left;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-weight: 800;
            font-size: 20px;
            white-space: nowrap;
        }

        /* æ¨¹å¹¹æŒ‰éˆ•å€åŸŸ */
        #trunk-container {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            margin-bottom: 100px; 
        }
        
        /* æ¨¹å¹¹æŒ‰éˆ•æ¨£å¼ */
        .trunk-btn {
            background-color: #8B5A2B;
            color: #fff;
            border: 3px solid #6d421b;
            width: 140px; 
            height: 70px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            border-radius: 8px; 
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .trunk-btn:active { transform: scale(0.95); }
        .trunk-btn:hover { background-color: #7a4e25; }

        /* åº•éƒ¨å·¥å…·åˆ— */
        #bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 -4px 30px rgba(0,0,0,0.3);
            padding: 60px 100px 60px 100px;
            z-index: 50;
            border-top: 6px solid #a00000;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .control-btn {
            padding: 12px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: 700;
            font-size: 16px;
            background-color: #e6e6e6;
            color: #4b5563;
            height: 50px;
        }
        .control-btn:hover { background-color: #e5e7eb; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .control-btn-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .control-btn-red:hover { background-color: #fecaca; }
        .control-btn-red:disabled { background-color: #f3f4f6; color: #9ca3af; }

        /* é€šç”¨ Modal æ¨£å¼ */
        .modal { 
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px); 
            z-index: 9999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: fixed;
            inset: 0;
        }

        @media (max-width: 600px) {
            .cup { width: 50px; height: 50px; font-size: 20px; margin: 3px; }
            .row-label { font-size: 16px; width: 70px; left: 5px; } 
            #calculation-log { 
                top: 70px; width: 100%; right: 0; padding: 10px; 
                max-height: 200px; background: none; 
                pointer-events: none;
            }
            .log-entry { background-color: rgba(255,255,255,0.5); } /* æ‰‹æ©Ÿç‰ˆç¨å¾®ä¸é€æ˜ä¸€é»é» */
            #bottom-toolbar { padding: 20px 20px 40px 20px; }
            .trunk-btn { width: 120px; height: 60px; font-size: 18px; }
        }

        #rule-pin-button { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body class="p-4">

    <!-- è¦å‰‡æŒ‰éˆ• -->
    <button id="rule-pin-button" class="p-3 bg-white text-gray-700 rounded-xl hover:bg-gray-100 transition shadow-lg border border-gray-100 mt-4">
        <span class="material-symbols-outlined mt-1" style="color: #a00000;">attach_file</span>
    </button>
    
    <!-- è¦å‰‡ Modal -->
    <div id="rule-modal" class="modal hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 border-t-4 border-[#a00000] m-auto relative animate-[scale-in_0.2s_ease-out]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-[#006400]">éŠæˆ²è¦å‰‡</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="rule-content" class="text-gray-700 space-y-3 max-h-96 overflow-y-auto text-sm">
                
                    <h3>ä½ æ˜¯ä¸€ä½<strong>ç…‰å­—è¡“å¸«</strong>ï¼Œé™¤äº†è¦ç²¾æº–çš„åœ¨ï¼™çƒå…§ç›¡å¯èƒ½æŠ•é€²æ„ˆå¤šéƒ¨ä»¶ã€åˆ©ç”¨éƒ¨ä»¶çµ„å­—ï¼Œé‚„å¿…é ˆæ»¿è¶³å®¢æˆ¶çš„éœ€æ±‚â‹¯â‹¯</h3>
                    <h2>è«‹å„ä½<strong>å­—çƒå¤šç¬¦ï¼</strong></h2>
                <p class="font-semibold text-[#a00000]">éŠæˆ²æµç¨‹</p>
                            
                <ul class="list-disc pl-2 space-y-1">
                <h3>1. æŠ•ï¼“çƒ ğŸŒ•ğŸŒ•ğŸŒ•<br>2. æŠ½å–ä¸€å¼µå®¢æˆ¶æ„è¦‹å¡<br>3. å†æŠ•ï¼“çƒ ğŸŒ•ğŸŒ•ğŸŒ•<br>4. æŠ½å–ä¸€å¼µå®¢æˆ¶æ„è¦‹å¡<br>5. æŠ•å®Œå‰©é¤˜çš„çƒ ğŸŒ•ğŸŒ•ğŸŒ•<br>6. åˆ©ç”¨æŠ•é€²çš„éƒ¨ä»¶ï¼Œåœ¨å°ç™½æ¿ä¸Šçµ„æˆå­—<br>7. çµç®—åˆ†æ•¸</h3></ul>
                <p class="font-semibold text-[#a00000]">è¨ˆåˆ†è¦å‰‡</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>æ¯æ’åˆ†æ•¸å¦‚å·¦å´æ¨™ç¤ºã€‚</li>
                    <li>ğŸ˜ˆ <strong>æƒ¡é­”</strong>
                        <ul class="pl-4 mt-1 border-l-2 border-red-100">
                                <li>åˆ†æ•¸ <strong>-3</strong></li>
                                <li>èˆ‡ç‚¸å½ˆçµ„åˆæˆ <strong>+20</strong>ï¼Œç§»é™¤æ‡²ç½°æ•ˆæœ</li>
                            </ul>
                    <li>ğŸ’£ <strong>ç‚¸å½ˆ</strong>
                        <ul class="pl-4 mt-1 border-l-2 border-red-100">
                            <li>å°‡æœ€é«˜åˆ†æ‰£é™¤</li>
                            <li>èˆ‡æƒ¡é­”çµ„åˆæˆ <strong>+20</strong>ï¼Œç§»é™¤æ‡²ç½°æ•ˆæœ</li>
                        
                        </ul>
                    </li>
                    <li>ğŸ”  <strong>çµ„å­—</strong>
                        <ul class="pl-4 mt-1 border-l-2 border-red-100">
                            <li><strong>+10</strong></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªæ¸…ç©º Modal -->
    <div id="confirm-modal" class="modal hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4 m-auto text-center">
            <div class="mb-4">
                <span class="material-symbols-outlined text-5xl text-red-500 mb-2">warning</span>
                <h3 class="text-xl font-bold text-gray-800">ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ</h3>
                <p class="text-gray-500 mt-2">æ‰€æœ‰çš„è¨ˆåˆ†ç´€éŒ„å°‡æœƒæ¶ˆå¤±ï¼Œç„¡æ³•å¾©åŸã€‚</p>
            </div>
            <div class="flex gap-3 justify-center">
                <button id="cancel-clear-btn" class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 w-full">å–æ¶ˆ</button>
                <button id="confirm-clear-btn" class="px-5 py-2.5 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 w-full shadow-lg shadow-red-200">ç¢ºå®šæ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- æ¨™é¡Œ -->
    <div class="text-center mb-10 mt-6">
        <h1 class="text-4xl font-extrabold tracking-tight text-white drop-shadow-lg mb-2">å­—çƒå¤šç¬¦</h1>
        <p class="text-white/80 font-medium">è¨ˆåˆ†å°å¹«æ‰‹</p>
    </div>

    <!-- ç›´å¼ç®—å¼ -->
    <div id="calculation-log"></div>

    <!-- æ¯å­å€åŸŸ -->
    <div id="cup-container"></div>
    
    <!-- æ¨¹å¹¹æŒ‰éˆ•å€åŸŸ -->
    <div id="trunk-container">
        <!-- JS å‹•æ…‹ç”ŸæˆæŒ‰éˆ• -->
    </div>

    <!-- åº•éƒ¨å·¥å…·åˆ— -->
    <div id="bottom-toolbar">
        <!-- åˆ†æ•¸èˆ‡é€²çƒæ•¸ä¸¦æ’ -->
        <div class="flex items-center justify-between gap-6 px-2">
            <!-- é€²çƒæ•¸ (æ”¾å¤§) -->
            <div class="flex flex-col items-start bg-gray-100 px-5 py-3 rounded-xl border-2 border-gray-200 min-w-[110px]">
                <span class="text-sm text-gray-500 font-bold uppercase tracking-wider">é€²çƒæ•¸</span>
                <span id="total-hits-display" class="text-4xl font-black text-gray-700 mt-1">0</span>
            </div>
            
            <!-- ç¸½åˆ† (æ”¾å¤§) -->
            <div class="flex flex-col items-end flex-grow">
                <span class="text-sm text-gray-500 font-bold uppercase tracking-wider mb-1">ç›®å‰åˆ†æ•¸</span>
                <span id="total-score-display" class="text-6xl font-black text-[#a00000] leading-none">0</span>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="flex gap-4 w-full mt-2">
            <button id="undo-button" disabled class="control-btn flex-1">
                <span class="material-symbols-outlined mr-2">undo</span> å¾©åŸ
            </button>
            <button id="clear-button" disabled class="control-btn control-btn-red flex-1">
                <span class="material-symbols-outlined mr-2">delete</span> é‡ç½®
            </button>
        </div>
    </div>

    <script>
        const initialCupData = [
            { id: 'star', content: 'â­', baseScore: 10, special: 'SCORABLE', row: 1 }, 
            { id: 'devil', content: 'ğŸ˜ˆ', baseScore: -3, special: 'DEVIL', row: 2 },   
            { id: 'bomb', content: 'ğŸ’£', baseScore: 0, special: 'BOMB', row: 2 }, 
            { id: 'ji', content: 'å³', baseScore: 5, special: 'SCORABLE', row: 3 },    
            { id: 'zhi', content: 'å¹ºç™½å¹º', baseScore: 5, special: 'SCORABLE', row: 3, classes: 'cup-small-text' }, 
            { id: 'feng', content: 'è±Š', baseScore: 5, special: 'SCORABLE', row: 3 },    
            { id: 'yang', content: 'å¤¬', baseScore: 3, special: 'SCORABLE', row: 4 },   
            { id: 'ren', content: 'å£¬', baseScore: 3, special: 'SCORABLE', row: 4 },
            { id: 'yan', content: 'å»¶', baseScore: 3, special: 'SCORABLE', row: 4 },
            { id: 'wu', content: 'å‹¿', baseScore: 3, special: 'SCORABLE', row: 4 },
            { id: 'niu', content: 'ç‰›', baseScore: 2, special: 'SCORABLE', row: 5 },   
            { id: 'zhu', content: 'ç«¹', baseScore: 2, special: 'SCORABLE', row: 5 },
            { id: 'er', content: 'è€³', baseScore: 2, special: 'SCORABLE', row: 5 },
            { id: 'mu', content: 'æœ¨', baseScore: 1, special: 'SCORABLE', row: 6 },    
            { id: 'kou', content: 'å£', baseScore: 1, special: 'SCORABLE', row: 6 },
            { id: 'xin', content: 'å¿ƒ', baseScore: 1, special: 'SCORABLE', row: 6 },
            { id: 'yan2', content: 'è¨€', baseScore: 1, special: 'SCORABLE', row: 6 },
            { id: 'shi', content: 'ç¤º', baseScore: 1, special: 'SCORABLE', row: 6 },
        ];

        const rowLabels = {
            1: '10',
            2: '-3 / æ‰£æœ€é«˜', 
            3: '5',
            4: '3',
            5: '2',
            6: '1'
        };

        const trunkConfig = { id: 'bonus_trunk', points: 10, label: 'çµ„å­—', text: 'çµ„å­— +10' };

        let history = []; 
        let actionLog = []; 
        const cupContainer = document.getElementById('cup-container');
        const calcLogEl = document.getElementById('calculation-log');
        const totalScoreDisplay = document.getElementById('total-score-display');
        const totalHitsDisplay = document.getElementById('total-hits-display');
        const trunkContainer = document.getElementById('trunk-container');

        // --- ç‹€æ…‹ç®¡ç† ---
        function saveHistory() {
            const logClone = JSON.parse(JSON.stringify(actionLog));
            history.push(logClone);
            if (history.length > 30) { history.shift(); }
            updateControlButtons();
        }
        
        function undoLastAction() {
            if (history.length > 0) {
                actionLog = history.pop();
                render();
            }
            updateControlButtons();
        }

        function updateControlButtons() {
            document.getElementById('undo-button').disabled = history.length === 0;
            document.getElementById('clear-button').disabled = actionLog.length === 0;
        }

        function initializeState() {
            history = []; 
            actionLog = []; 
            render();
        }

        function handleCupClick(cupId) {
            saveHistory();
            actionLog.push({ type: 'cup', id: cupId });
            render();
        }

        function handleBonusClick(points, label, bonusId) {
            saveHistory();
            actionLog.push({ type: 'bonus', value: points, label: label, bonusId: bonusId });
            render();
        }

        function render() {
            renderCups();
            renderTrunkButton();
            calculateAndRenderLog();
            updateControlButtons();
        }

        function renderTrunkButton() {
            trunkContainer.innerHTML = '';
            
            // è¨ˆç®—é»æ“Šæ¬¡æ•¸
            let count = 0;
            actionLog.forEach(action => {
                if (action.type === 'bonus' && action.bonusId === trunkConfig.id) {
                    count++;
                }
            });

            const btn = document.createElement('button');
            btn.className = 'trunk-btn';
            
            const badgeHtml = count > 0 ? `<span class="hit-count" style="top: -8px; right: -8px; bottom: auto;">${count}</span>` : '';

            btn.innerHTML = `${trunkConfig.text} ${badgeHtml}`;
            btn.onclick = () => handleBonusClick(trunkConfig.points, trunkConfig.label, trunkConfig.id);
            trunkContainer.appendChild(btn);
        }

        function renderCups() {
            cupContainer.innerHTML = '';
            const hitCounts = {};
            let totalCupHits = 0; 

            actionLog.forEach(action => {
                if(action.type === 'cup') {
                    hitCounts[action.id] = (hitCounts[action.id] || 0) + 1;
                    totalCupHits++;
                }
            });

            totalHitsDisplay.textContent = totalCupHits;

            const cupsByRow = {};
            initialCupData.forEach(c => {
                if(!cupsByRow[c.row]) cupsByRow[c.row] = [];
                cupsByRow[c.row].push(c);
            });

            Object.keys(cupsByRow).sort((a,b) => a-b).forEach(rowKey => {
                const rowEl = document.createElement('div');
                rowEl.className = 'cup-row';
                
                const labelEl = document.createElement('div');
                labelEl.className = 'row-label';
                labelEl.textContent = rowLabels[rowKey] || '';
                rowEl.appendChild(labelEl);

                const wrapper = document.createElement('div');
                wrapper.className = 'flex justify-center items-center gap-1';
                
                cupsByRow[rowKey].forEach(cupDef => {
                    const hits = hitCounts[cupDef.id] || 0;
                    const cupEl = document.createElement('div');
                    cupEl.className = 'cup';
                    cupEl.dataset.id = cupDef.id;
                    cupEl.dataset.score = cupDef.baseScore;
                    if(cupDef.classes) cupEl.classList.add(cupDef.classes);
                    
                    cupEl.innerHTML = `
                        ${cupDef.content}
                        ${hits > 0 ? `<span class="hit-count">${hits}</span>` : ''}
                    `;
                    cupEl.onclick = () => handleCupClick(cupDef.id);
                    wrapper.appendChild(cupEl);
                });
                rowEl.appendChild(wrapper);
                cupContainer.appendChild(rowEl);
            });
        }

        // --- æ ¸å¿ƒé‹ç®— ---
        function calculateAndRenderLog() {
            let displayItems = []; 
            
            let devilIndices = [];
            let bombIndices = [];
            
            actionLog.forEach((action, idx) => {
                let item = {
                    logIdx: idx,
                    type: action.type,
                    desc: '',
                    value: 0,
                    isCancelled: false, 
                    isCombo: false, 
                    isBombDeduction: false
                };

                if (action.type === 'cup') {
                    const cup = initialCupData.find(c => c.id === action.id);
                    if (cup.id === 'devil') {
                        item.desc = `ğŸ˜ˆ`; 
                        item.value = -3;
                        devilIndices.push(idx);
                    } else if (cup.id === 'bomb') {
                        item.desc = `ğŸ’£`; 
                        item.value = 0;
                        bombIndices.push(idx);
                    } else {
                        item.desc = `${cup.content}`;
                        item.value = cup.baseScore;
                    }
                } else if (action.type === 'bonus') {
                    item.desc = `ğŸ”  ${action.label}`;
                    item.value = action.value;
                }
                displayItems.push(item);
            });

            // 2. è™•ç†çµ„åˆ
            const comboCount = Math.min(devilIndices.length, bombIndices.length);
            for (let i = 0; i < comboCount; i++) {
                const dIdx = devilIndices[i];
                const bIdx = bombIndices[i];
                displayItems[dIdx].isCancelled = true;
                displayItems[bIdx].value = 20; 
                displayItems[bIdx].desc = `ğŸ˜ˆ+ğŸ’£ çµ„åˆ`;
                displayItems[bIdx].isCombo = true;
            }

            // 3. è™•ç†å‰©é¤˜ç‚¸å½ˆçš„æ‰£åˆ†é‚è¼¯
            const excessBombCount = bombIndices.length - comboCount;
            const excessBombIndices = bombIndices.slice(comboCount);

            excessBombIndices.forEach(bLogIdx => {
                let candidates = displayItems.filter(item => 
                    !item.isCancelled && 
                    item.value > 0 && 
                    item.type !== 'bonus' 
                );
                
                if (candidates.length > 0) {
                    candidates.sort((a, b) => b.value - a.value);
                    const target = candidates[0];
                    target.isCancelled = true;
                    
                    let targetName = target.desc; 
                    if (target.isCombo) targetName = "çµ„åˆåˆ†";
                    
                    displayItems[bLogIdx].desc = `ğŸ’£ æŠµéŠ· ${targetName}`;
                    displayItems[bLogIdx].isBombDeduction = true;
                } else {
                    displayItems[bLogIdx].desc = `ğŸ’£ ç„¡åˆ†å¯æ‰£`;
                }
            });

            // 4. è¨ˆç®—ç¸½åˆ† & æ¸²æŸ“
            let total = 0;
            displayItems.forEach(item => {
                if (!item.isCancelled) total += item.value;
            });

            // æ¸²æŸ“
            calcLogEl.innerHTML = '';
            // ä¿®æ”¹ï¼šä¸ä½¿ç”¨ reverse()ï¼Œä¿æŒæ–°çš„åœ¨ä¸‹é¢
            const renderList = [...displayItems]; 

            if (renderList.length === 0) {
                calcLogEl.innerHTML = '<div class="text-center text-white/50 mt-1 font-medium text-sm">é»æ“Šæ¯å­é–‹å§‹è¨ˆåˆ†</div>';
            } else {
                renderList.forEach(item => {
                    const row = document.createElement('div');
                    let classes = 'log-entry';
                    if (item.isCancelled) classes += ' strike-through';
                    
                    let descHtml = item.desc;
                    if (item.isCombo && !item.isCancelled) descHtml = `<span class="text-combo">${item.desc}</span>`;
                    if (item.isBombDeduction) descHtml = `<span class="text-bomb">${item.desc}</span>`;
                    if (item.type === 'bonus') descHtml = `<span class="text-bonus">${item.desc}</span>`;

                    let valHtml = '';
                    if (item.value !== 0 && !item.isBombDeduction) {
                        valHtml = item.value;
                    }

                    row.className = classes;
                    row.innerHTML = `
                        <span class="log-desc">${descHtml}</span>
                        <span class="log-value">${valHtml}</span>
                    `;
                    calcLogEl.appendChild(row);
                });
                // ä¿®æ”¹ï¼šè‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
                calcLogEl.scrollTop = calcLogEl.scrollHeight;
            }

            // æ›´æ–°ç¸½åˆ†
            totalScoreDisplay.textContent = total;
            if(total > 0) totalScoreDisplay.style.color = '#006400';
            else totalScoreDisplay.style.color = '#a00000';
        }

        window.onload = () => {
            initializeState();
            
            // è¦å‰‡ Modal
            const ruleModal = document.getElementById('rule-modal');
            document.getElementById('rule-pin-button').onclick = () => {
                ruleModal.classList.remove('hidden');
            };
            document.getElementById('close-modal').onclick = () => {
                ruleModal.classList.add('hidden');
            };
            ruleModal.onclick = (e) => { 
                if(e.target === ruleModal) {
                    ruleModal.classList.add('hidden');
                }
            };

            // ç¢ºèªæ¸…ç©º Modal
            const confirmModal = document.getElementById('confirm-modal');
            const clearButton = document.getElementById('clear-button');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const confirmClearBtn = document.getElementById('confirm-clear-btn');

            clearButton.onclick = () => {
                if(actionLog.length > 0) {
                    confirmModal.classList.remove('hidden');
                }
            };

            cancelClearBtn.onclick = () => {
                confirmModal.classList.add('hidden');
            };

            confirmClearBtn.onclick = () => {
                saveHistory(); 
                actionLog = [];
                render();
                confirmModal.classList.add('hidden');
            };

            // é»æ“Š Modal å¤–éƒ¨é—œé–‰
            confirmModal.onclick = (e) => {
                if(e.target === confirmModal) {
                    confirmModal.classList.add('hidden');
                }
            };

            document.getElementById('undo-button').onclick = undoLastAction;
        };
    </script>
</body>
</html>